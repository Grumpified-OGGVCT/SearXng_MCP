name: Weekly Dependency Update Check

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools pip-audit
    
    - name: Check for dependency updates
      id: check_updates
      run: |
        # Install current dependencies
        pip install -r requirements.txt
        
        # Generate current versions
        pip list --format=json > current_versions.json
        
        # Check for outdated packages
        pip list --outdated --format=json > outdated.json
        
        # Check if there are updates
        if [ -s outdated.json ] && [ "$(cat outdated.json)" != "[]" ]; then
          echo "updates_available=true" >> $GITHUB_OUTPUT
          echo "## Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Current | Latest | Type |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|------|" >> $GITHUB_STEP_SUMMARY
          python -c "
import json
with open('outdated.json') as f:
    outdated = json.load(f)
for pkg in outdated:
    print(f\"| {pkg['name']} | {pkg['version']} | {pkg['latest_version']} | {pkg['latest_filetype']} |\")" >> $GITHUB_STEP_SUMMARY
        else
          echo "updates_available=false" >> $GITHUB_OUTPUT
          echo "No outdated dependencies found! ✅" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Security audit
      id: audit
      run: |
        pip-audit --format=json > audit.json || true
        
        if [ -s audit.json ]; then
          vulnerabilities=$(python -c "import json; print(len(json.load(open('audit.json'))['vulnerabilities']))")
          if [ "$vulnerabilities" -gt 0 ]; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ⚠️ Security Vulnerabilities Found: $vulnerabilities" >> $GITHUB_STEP_SUMMARY
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Security: No vulnerabilities found ✅" >> $GITHUB_STEP_SUMMARY
          fi
        fi
    
    - name: Check FastMCP for updates
      id: check_fastmcp
      run: |
        # Get current FastMCP version
        current=$(pip show fastmcp | grep Version | cut -d' ' -f2)
        
        # Get latest version from PyPI
        latest=$(curl -s https://pypi.org/pypi/fastmcp/json | python -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
        
        echo "current_fastmcp=$current" >> $GITHUB_OUTPUT
        echo "latest_fastmcp=$latest" >> $GITHUB_OUTPUT
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## FastMCP Version" >> $GITHUB_STEP_SUMMARY
        echo "- Current: $current" >> $GITHUB_STEP_SUMMARY
        echo "- Latest: $latest" >> $GITHUB_STEP_SUMMARY
        
        if [ "$current" != "$latest" ]; then
          echo "fastmcp_update=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Check httpx for updates
      id: check_httpx
      run: |
        current=$(pip show httpx | grep Version | cut -d' ' -f2)
        latest=$(curl -s https://pypi.org/pypi/httpx/json | python -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
        
        echo "current_httpx=$current" >> $GITHUB_OUTPUT
        echo "latest_httpx=$latest" >> $GITHUB_OUTPUT
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## HTTPX Version" >> $GITHUB_STEP_SUMMARY
        echo "- Current: $current" >> $GITHUB_STEP_SUMMARY
        echo "- Latest: $latest" >> $GITHUB_STEP_SUMMARY
    
    - name: Create issue if updates available
      if: steps.check_updates.outputs.updates_available == 'true' || steps.audit.outputs.vulnerabilities_found == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let body = '## Weekly Dependency Update Check\n\n';
          body += '**Date:** ' + new Date().toISOString().split('T')[0] + '\n\n';
          
          if ('${{ steps.audit.outputs.vulnerabilities_found }}' === 'true') {
            body += '### ⚠️ Security Vulnerabilities Detected\n\n';
            body += 'Security vulnerabilities were found in dependencies. Please review and update immediately.\n\n';
            body += '```bash\npip-audit\n```\n\n';
          }
          
          if ('${{ steps.check_updates.outputs.updates_available }}' === 'true') {
            body += '### Available Updates\n\n';
            const outdated = JSON.parse(fs.readFileSync('outdated.json', 'utf8'));
            body += '| Package | Current | Latest | Type |\n';
            body += '|---------|---------|--------|------|\n';
            outdated.forEach(pkg => {
              body += `| ${pkg.name} | ${pkg.version} | ${pkg.latest_version} | ${pkg.latest_filetype} |\n`;
            });
            body += '\n';
          }
          
          body += '### Update Instructions\n\n';
          body += '```bash\n';
          body += '# Update specific package\n';
          body += 'pip install --upgrade <package-name>\n\n';
          body += '# Update requirements.txt\n';
          body += 'pip freeze > requirements.txt\n\n';
          body += '# Test changes\n';
          body += 'pytest tests/\n';
          body += '```\n\n';
          body += '### Checklist\n';
          body += '- [ ] Review changelog for breaking changes\n';
          body += '- [ ] Update dependencies\n';
          body += '- [ ] Run tests\n';
          body += '- [ ] Update documentation if needed\n';
          body += '- [ ] Create PR with changes\n';
          
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'dependencies,automated',
            state: 'open'
          });
          
          if (issues.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[AUTO] Weekly Dependency Updates Available - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['dependencies', 'automated', '${{ steps.audit.outputs.vulnerabilities_found == 'true' && 'security' || '' }}'].filter(Boolean)
            });
          }
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-results
        path: |
          outdated.json
          audit.json
          current_versions.json
